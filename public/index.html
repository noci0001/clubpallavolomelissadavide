<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Club Pallavolo</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#020617">

  <style>
    :root{
      --bg:#020617;
      --card:#0b1120;
      --border:#1f2937;
      --text:#f9fafb;
      --muted:#9ca3af;
      --disabled:#4b5563;
      --accent:#f97316;
      --blue:#2563eb;
      --green:#22c55e;
      --red:#ef4444;
      --yellow:#eab308;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .app{max-width:960px;margin:0 auto;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .between{justify-content:space-between}
    .tabs{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .tab{
      flex:1;
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      text-align:center;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#000;
      font-weight:700;
    }
    .btn{
      border:0;
      border-radius:8px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      color:#000;
      background:var(--accent);
    }
    .btn.secondary{background:var(--blue); color:#fff}
    .btn.ghost{
      background:transparent;
      color:var(--muted);
      border:1px solid var(--disabled);
      font-weight:600;
      padding:6px 10px;
      border-radius:6px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
    }
    .hero{margin:12px 0 16px}
    .hero .l1{font-size:32px;font-weight:800}
    .hero .l2{font-size:18px;font-weight:800;color:var(--accent);margin-top:4px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    input{
      width:100%;
      background:var(--bg);
      border:1px solid #374151;
      border-radius:8px;
      padding:10px 10px;
      color:var(--text);
      outline:none;
    }
    .divider{height:1px;background:var(--border);margin:10px 0}
    .calendarWrap{padding:12px}
    .calHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .calHeader .title{font-weight:800}
    .calGrid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
    }
    .dow{
      font-size:12px;
      color:var(--disabled);
      text-align:center;
      padding:6px 0;
    }
    .day{
      border-radius:8px;
      border:1px solid var(--border);
      min-height:54px;
      padding:6px 6px 4px;
      cursor:pointer;
      user-select:none;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .day.disabled{opacity:.35; cursor:not-allowed}
    .day.selected{background:var(--accent); border-color:var(--accent); color:#000}
    .dayNum{font-size:14px}
    .dayIcon{font-size:14px;text-align:center;min-height:16px}
    .pill{
      border-radius:999px;
      padding:3px 10px;
      font-size:12px;
      font-weight:800;
      display:inline-block;
    }
    .pill.green{background:var(--green); color:#000}
    .pill.red{background:var(--red); color:#000}
    .pill.yellow{background:var(--yellow); color:#000}
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(920px, 96vw);
      height:min(520px, 88vh);
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      overflow:auto;
    }
  </style>
</head>
<body>
  <div class="app" id="app"></div>

  <div class="overlay" id="overlay">
    <div class="modal" id="modal"></div>
  </div>

<script>
/* =========================
   PWA + PUSH CONFIG
   ========================= */

const VAPID_PUBLIC_KEY = "BCTipjxiFUlUNTKXHSv-3BBA60tDJ9k6TZVHmZAIxP6ZxXpn_YMNbCCFMdNd5-bYxzSRIJ8uWJm8UBIAIefGsnA";

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const raw = atob(base64);
  const output = new Uint8Array(raw.length);
  for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
  return output;
}

async function registerServiceWorker() {
  if (!("serviceWorker" in navigator)) throw new Error("Service Worker non supportato");
  return navigator.serviceWorker.register("/sw.js");
}

async function subscribeToPush() {
  if (!("PushManager" in window)) throw new Error("Push non supportato su questo browser");
  const reg = await registerServiceWorker();

  const permission = await Notification.requestPermission();
  if (permission !== "granted") throw new Error("Permesso notifiche negato");

  const existing = await reg.pushManager.getSubscription();
  if (existing) return existing;

  return reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
  });
}

async function sendSubscriptionToBackend(subscription) {
  const res = await fetch("/.netlify/functions/subscribe", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ subscription })
  });
  if (!res.ok) throw new Error("Subscribe API failed");
}

/* =====================
   Helpers
   ===================== */

const STORAGE_USER = "volleyclub_user";
const STORAGE_NOTIF_ENABLED = "volleyclub_notif_enabled";

// JS: 0=Dom ... 6=Sab
const TRAINING_WEEKDAYS = [1,2,3,4,6]; // Lun-Gio + Sab
const TRAINING_SLOTS = {
  1: [{start:18.0,end:19.5},{start:19.5,end:21.0},{start:21.0,end:22.5}],
  2: [{start:18.0,end:19.5},{start:19.5,end:21.0},{start:21.0,end:22.5}],
  3: [{start:18.0,end:19.5},{start:19.5,end:21.0},{start:21.0,end:22.5}],
  4: [{start:18.0,end:19.5},{start:19.5,end:21.0},{start:21.0,end:22.5}],
  6: [{start:9.5,end:11.0},{start:11.0,end:12.5}],
};

const IT = {
  monthNames: ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],
  dayNames: ["Domenica","Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato"],
  dayNamesShort: ["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],
};

const $ = (sel) => document.querySelector(sel);
const appEl = $("#app");
const overlayEl = $("#overlay");
const modalEl = $("#modal");

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){ return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function ymd(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function parseYMD(s){
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
}
function isTrainingDay(dateStr){
  const d = parseYMD(dateStr);
  return TRAINING_WEEKDAYS.includes(d.getDay());
}
function isMatchDay(dateStr){
  const d = parseYMD(dateStr);
  return d.getDay() === 0;
}
function getSlotsForDate(dateStr){
  const d = parseYMD(dateStr);
  return TRAINING_SLOTS[d.getDay()] || [];
}
function formatHourLabel(hourFloat){
  const h = Math.floor(hourFloat);
  const minutes = Math.round((hourFloat - h) * 60);
  const mm = String(minutes).padStart(2,"0");
  return `${String(h).padStart(2,"0")}:${mm}`;
}
function formatSlotLabel(s){
  return `${formatHourLabel(s.start)}‚Äì${formatHourLabel(s.end)}`;
}
function formatFullItalianDate(dateStr){
  const d = parseYMD(dateStr);
  const weekday = IT.dayNames[d.getDay()].toLowerCase();
  const day = d.getDate();
  const month = IT.monthNames[d.getMonth()].toLowerCase();
  const year = d.getFullYear();
  return `${weekday} ${day} ${month} ${year}`;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =====================
   DB sync (availability)
   ===================== */

async function apiGetMyAvailability(training_date){
  const res = await fetch("/.netlify/functions/get_availability", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      member_id: state.user.id,
      training_date
    })
  });
  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || "get_availability failed");
  return j.status ?? null; // 'yes' | 'no' | 'maybe' | null
}

async function apiSetMyAvailability(training_date, status){
  const res = await fetch("/.netlify/functions/set_availability", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      member_id: state.user.id,
      training_date,
      status
    })
  });
  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || "set_availability failed");
  return j.status ?? status;
}

/* =====================
   App State
   ===================== */

let state = {
  user: loadJSON(STORAGE_USER, null),
  authMode: "login",
  authError: null,
  authForm: { nome: "", code: "", birthYear: "" },

  notificationsEnabled: (localStorage.getItem(STORAGE_NOTIF_ENABLED) === "true"),

  selectedDate: null,
  trainingDate: null,

  myAvailabilityCache: {} // cache UI (not source of truth)
};

function persist(){
  if(state.user) saveJSON(STORAGE_USER, state.user);
  localStorage.setItem(STORAGE_NOTIF_ENABLED, state.notificationsEnabled ? "true" : "false");
}

/* =====================
   Notifications toggle
   ===================== */

async function handleToggleNotifications(){
  if(!state.notificationsEnabled){
    try{
      const sub = await subscribeToPush();
      await sendSubscriptionToBackend(sub);

      state.notificationsEnabled = true;
      persist();
      render();
      alert("Notifiche abilitate ‚úÖ (serve che l'app sia installata su iOS)");
    }catch(e){
      alert("Non riesco ad abilitare le notifiche: " + (e?.message || e));
      state.notificationsEnabled = false;
      persist();
      render();
    }
  }else{
    state.notificationsEnabled = false;
    persist();
    render();
    alert("Notifiche disabilitate.");
  }
}

/* =====================
   Auth
   ===================== */

async function apiLoginMember(nome, code){
  const res = await fetch("/.netlify/functions/login_member", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ name: nome, code })
  });
  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || "Login failed");
  return j.user;
}

async function apiSignupMember(nome, birthYear){
  const res = await fetch("/.netlify/functions/signup_member", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ name: nome, birth_year: Number(birthYear) })
  });
  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || "Signup failed");
  return j.user;
}

async function handleSignup(){
  state.authError = null;
  const f = state.authForm;

  const nome = (f.nome || "").trim();
  const birthYear = String(f.birthYear || "").trim();

  if(!nome || !birthYear){
    state.authError = "Inserisci nome e anno di nascita.";
    render();
    return;
  }

  const y = Number(birthYear);
  if(!Number.isInteger(y) || y < 1900 || y > 2100){
    state.authError = "Anno di nascita non valido (es. 2000).";
    render();
    return;
  }

  try{
    const user = await apiSignupMember(nome, y);
    state.user = user;
    state.myAvailabilityCache = {};
    persist();
    render();
    alert(`Registrato! Il tuo codice √®: ${user.member_code}`);
  }catch(e){
    state.authError = e?.message || String(e);
    render();
  }
}

async function handleLogin(){
  state.authError = null;
  const f = state.authForm;

  const nome = (f.nome || "").trim();
  const code = (f.code || "").trim().toUpperCase();

  if(!nome || !code){
    state.authError = "Inserisci nome e codice.";
    render();
    return;
  }

  try{
    const user = await apiLoginMember(nome, code);
    state.user = user;
    state.myAvailabilityCache = {};
    persist();
    render();
  }catch(e){
    state.authError = e?.message || String(e);
    render();
  }
}

function handleLogout(){
  localStorage.removeItem(STORAGE_USER);
  state.user = null;
  state.notificationsEnabled = false;
  localStorage.setItem(STORAGE_NOTIF_ENABLED, "false");
  state.authForm = { nome:"", code:"", birthYear:"" };
  state.authMode = "login";
  state.myAvailabilityCache = {};
  closeOverlay();
  render();
}

/* =====================
   Maps
   ===================== */

function openMaps(){
  const query = encodeURIComponent("Palestra di Villaverla");
  const url = `https://www.google.com/maps/dir/?api=1&destination=${query}`;
  window.open(url, "_blank");
}

/* =====================
   Overlay (allenamento)
   ===================== */

function closeOverlay(){
  overlayEl.classList.remove("open");
  state.trainingDate = null;
}

overlayEl.addEventListener("click", (e) => {
  if(e.target === overlayEl) closeOverlay();
});

function pillForStatus(status){
  if(status==="yes") return `<span class="pill green">‚úÖ Presente</span>`;
  if(status==="no") return `<span class="pill red">‚ùå Assente</span>`;
  if(status==="maybe") return `<span class="pill yellow">‚ùì Forse</span>`;
  return `<span class="muted">non specificata</span>`;
}

async function openTrainingView(dateStr){
  if(!isTrainingDay(dateStr)) return;

  state.trainingDate = dateStr;
  overlayEl.classList.add("open");

  modalEl.innerHTML = `
    <div class="row between">
      <div>
        <div style="font-size:20px;font-weight:800;color:var(--accent)">Allenamento</div>
        <div style="font-size:14px">${formatFullItalianDate(dateStr)}</div>
      </div>
      <button class="btn" id="closeModal">CHIUDI</button>
    </div>
    <div class="divider"></div>
    <div class="muted">Carico dal database...</div>
  `;
  $("#closeModal").onclick = closeOverlay;

  try{
    const status = await apiGetMyAvailability(dateStr);
    state.myAvailabilityCache[dateStr] = status;
    renderOverlay(dateStr, status);
  }catch(e){
    modalEl.innerHTML = `
      <div class="row between">
        <div>
          <div style="font-size:20px;font-weight:800;color:var(--accent)">Allenamento</div>
          <div style="font-size:14px">${formatFullItalianDate(dateStr)}</div>
        </div>
        <button class="btn" id="closeModal">CHIUDI</button>
      </div>
      <div class="divider"></div>
      <div style="color:var(--red);font-size:13px">
        Errore caricando la presenza: ${escapeHtml(e?.message || String(e))}
      </div>
      <div class="small muted" style="margin-top:8px">
        Tip: apri DevTools ‚Üí Network ‚Üí guarda la chiamata a get_availability e lo status code.
      </div>
    `;
    $("#closeModal").onclick = closeOverlay;
  }
}

function renderOverlay(dateStr, status){
  modalEl.innerHTML = `
    <div class="row between">
      <div>
        <div style="font-size:20px;font-weight:800;color:var(--accent)">Allenamento</div>
        <div style="font-size:14px">${formatFullItalianDate(dateStr)}</div>
      </div>
      <button class="btn" id="closeModal">CHIUDI</button>
    </div>

    <div class="divider"></div>

    <div style="font-weight:800;margin-bottom:6px">La tua presenza (sync DB)</div>
    <div class="row">
      <button class="btn" style="background:var(--green)" id="meYes">‚úÖ Presente</button>
      <button class="btn" style="background:var(--red);color:#fff" id="meNo">‚ùå Assente</button>
      <button class="btn" style="background:var(--yellow)" id="meMaybe">‚ùì Forse</button>
    </div>

    <div style="margin-top:10px" class="row">
      <div class="muted">Stato attuale:</div>
      <div id="statusPill">${pillForStatus(status)}</div>
    </div>

    <div class="divider"></div>

    <div class="small muted">
      Turni: ${getSlotsForDate(dateStr).map(formatSlotLabel).join(" / ")}
    </div>
  `;

  $("#closeModal").onclick = closeOverlay;

  const set = async (newStatus) => {
    $("#meYes").disabled = true;
    $("#meNo").disabled = true;
    $("#meMaybe").disabled = true;

    try{
      await apiSetMyAvailability(dateStr, newStatus);
      state.myAvailabilityCache[dateStr] = newStatus;
      $("#statusPill").innerHTML = pillForStatus(newStatus);
    }catch(e){
      alert("Errore salvataggio DB: " + (e?.message || e));
    }finally{
      $("#meYes").disabled = false;
      $("#meNo").disabled = false;
      $("#meMaybe").disabled = false;
    }
  };

  $("#meYes").onclick = () => set("yes");
  $("#meNo").onclick = () => set("no");
  $("#meMaybe").onclick = () => set("maybe");
}

/* =====================
   Calendar UI
   ===================== */

function buildMonthCells(year, monthIndex){
  const first = new Date(year, monthIndex, 1);
  const startDow = (first.getDay() + 6) % 7; // Monday=0
  const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

  const cells = [];
  for(let i=0;i<startDow;i++) cells.push(null);
  for(let d=1; d<=daysInMonth; d++){
    const dt = new Date(year, monthIndex, d);
    cells.push(dt);
  }
  while(cells.length % 7 !== 0) cells.push(null);
  return cells;
}

function renderMonthGrid(y,m,activeDate){
  const cells = buildMonthCells(y,m);
  return cells.map((dt) => {
    if(!dt){
      return `<div class="day disabled" style="visibility:hidden"></div>`;
    }
    const dateStr = ymd(dt);
    const training = isTrainingDay(dateStr);
    const match = isMatchDay(dateStr);
    const selected = dateStr === activeDate;

    const icon = match ? "‚≠ê" : (training ? "üèê" : "");
    return `
      <div class="day ${selected?"selected":""}" data-day="${dateStr}">
        <div class="dayNum">${dt.getDate()}</div>
        <div class="dayIcon">${icon}</div>
      </div>
    `;
  }).join("");
}

function renderCalendarPage(activeDate){
  const nome = state.user?.nome || "User";
  const d = parseYMD(activeDate);
  if(!state._calYM){
    state._calYM = { y: d.getFullYear(), m: d.getMonth() };
  }
  const {y, m} = state._calYM;

  const training = isTrainingDay(activeDate);

  return `
    <div class="hero">
      <div class="l1">CIAO, ${escapeHtml(nome).toUpperCase()}!</div>
      <div class="l2">BENVENUTO NEL TUO CLUB DI PALLAVOLO!</div>
    </div>

    <div class="row between" style="margin-bottom:10px">
      <div class="row">
        <button class="btn" id="todayBtn">OGGI</button>
        <button class="btn secondary" id="mapsBtn">NAVIGA VERSO</button>
        ${training ? `<button class="btn" style="background:var(--green)" id="openTraining">APRI ALLENAMENTO</button>` : ``}
      </div>

      <div class="row" style="gap:10px">
        <div class="small">Promemoria allenamento</div>
        <label class="row" style="gap:8px;cursor:pointer;user-select:none">
          <input type="checkbox" id="notifToggle" ${state.notificationsEnabled?"checked":""} />
          <span class="muted small">${state.notificationsEnabled?"ON":"OFF"}</span>
        </label>
      </div>
    </div>

    <div class="card calendarWrap">
      <div class="calHeader">
        <button class="btn ghost" id="prevMonth">‚Üê</button>
        <div class="title">${IT.monthNames[m]} ${y}</div>
        <button class="btn ghost" id="nextMonth">‚Üí</button>
      </div>

      <div class="calGrid">
        ${IT.dayNamesShort.slice(1).concat(IT.dayNamesShort[0]).map(n => `<div class="dow">${n}</div>`).join("")}
        ${renderMonthGrid(y,m,activeDate)}
      </div>

      <div class="small muted" style="margin-top:8px">
        üèê = allenamento (Lun-Gio, Sab) ‚Ä¢ ‚≠ê = partita (Domenica)
      </div>
    </div>
  `;
}

/* =====================
   Main render
   ===================== */

function render(){
  const today = ymd(new Date());
  const activeDate = state.selectedDate || today;

  if(!state.user){
    appEl.innerHTML = renderAuth();
    bindAuth();
    return;
  }

  appEl.innerHTML = `
    <div class="tabs">
      <div class="tab active">CALENDARIO</div>
      <button class="btn ghost" id="logoutBtn">Logout</button>
    </div>

    ${renderCalendarPage(activeDate)}
  `;

  $("#logoutBtn").onclick = handleLogout;
  bindCalendar(activeDate);
}

function renderAuth(){
  const a = state.authMode;
  const err = state.authError;
  const f = state.authForm;

  return `
    <div class="card" style="padding:24px">
      <div style="font-size:28px;font-weight:900;margin-bottom:6px">Benvenut* nel Club di Pallavolo</div>
      <div class="muted small" style="margin-bottom:18px">
        ${a==="login"
          ? "Accedi con Nome + Codice."
          : "Registrati con Nome + Anno di nascita. Il codice viene generato automaticamente."}
      </div>

      <div class="row" style="border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:14px">
        <div class="tab ${a==="login"?"active":""}" style="border:0" data-auth="login">LOGIN</div>
        <div class="tab ${a==="signup"?"active":""}" style="border:0" data-auth="signup">REGISTRAZIONE</div>
      </div>

      <div style="display:grid;gap:10px">
        <input id="nome" placeholder="Nome (es. Sam)" value="${escapeHtml(f.nome)}" />

        ${a==="login" ? `
          <input id="code" placeholder="Codice (es. SAM-2000)" value="${escapeHtml(f.code)}" />
        ` : `
          <input id="birthYear" placeholder="Anno di nascita (es. 2000)" value="${escapeHtml(f.birthYear)}" />
          <div class="small muted">Il codice sar√†: PRIME 3 LETTERE + "-" + ANNO (es. SAM-2000)</div>
        `}

        ${err ? `<div style="color:var(--red);font-size:12px">${escapeHtml(err)}</div>` : ""}

        <button class="btn" id="authSubmit">${a==="login" ? "Accedi" : "Crea account"}</button>
      </div>
    </div>
  `;
}

function bindAuth(){
  appEl.querySelectorAll("[data-auth]").forEach(el => {
    el.onclick = () => {
      state.authMode = el.getAttribute("data-auth");
      state.authError = null;
      render();
    };
  });

  $("#nome").oninput = (e) => state.authForm.nome = e.target.value;

  if(state.authMode === "login"){
    $("#code").oninput = (e) => state.authForm.code = e.target.value;
  }else{
    $("#birthYear").oninput = (e) => state.authForm.birthYear = e.target.value;
  }

  $("#authSubmit").onclick = () => {
    if(state.authMode==="login") handleLogin();
    else handleSignup();
  };
}

function bindCalendar(activeDate){
  $("#todayBtn").onclick = () => { state.selectedDate = null; render(); };
  $("#mapsBtn").onclick = openMaps;
  $("#notifToggle").onchange = handleToggleNotifications;

  $("#prevMonth").onclick = () => {
    state._calYM.m -= 1;
    if(state._calYM.m < 0){ state._calYM.m = 11; state._calYM.y -= 1; }
    render();
  };
  $("#nextMonth").onclick = () => {
    state._calYM.m += 1;
    if(state._calYM.m > 11){ state._calYM.m = 0; state._calYM.y += 1; }
    render();
  };

  appEl.querySelectorAll("[data-day]").forEach(el => {
    el.onclick = () => {
      state.selectedDate = el.getAttribute("data-day");
      render();
    };
  });

  const openBtn = $("#openTraining");
  if(openBtn){
    openBtn.onclick = () => openTrainingView(activeDate);
  }
}

/* =====================
   Boot
   ===================== */

render();
</script>
</body>
</html>
