<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äì Presenze</title>

  <style>
    :root{
      --bg:#020617;
      --card:#0b1120;
      --border:#1f2937;
      --text:#f9fafb;
      --muted:#9ca3af;
      --accent:#f97316;
      --green:#22c55e;
      --red:#ef4444;
      --yellow:#eab308;
      --gray:#4b5563;
      --blue:#2563eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .app{max-width:980px;margin:0 auto;padding:16px}
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .title{font-size:22px;font-weight:900;color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}
    .btn{
      border:0;border-radius:10px;padding:10px 12px;
      font-weight:900;cursor:pointer;
      background:var(--blue);color:#fff;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin-bottom:12px;
    }
    .dayTitle{font-size:16px;font-weight:900;margin-bottom:10px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr}
    }
    .bucket{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      min-height:90px;
    }
    .bucketTitle{
      display:flex;align-items:center;justify-content:space-between;
      font-weight:900;margin-bottom:8px;
    }
    .pill{
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight:900;
      color:#000;
    }
    .pill.green{background:var(--green)}
    .pill.red{background:var(--red)}
    .pill.yellow{background:var(--yellow)}
    .pill.gray{background:#9ca3af}
    .names{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .nameChip{
      border:1px solid var(--gray);
      border-radius:999px;
      padding:4px 10px;
      font-size:13px;
      color:#e5e7eb;
      background:transparent;
    }
    .empty{color:var(--muted);font-size:13px}
    .sep{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div>
        <div class="title">Dashboard presenze (settimana)</div>
        <div class="muted" id="subtitle">Caricamento‚Ä¶</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="reload">RICARICA</button>
      </div>
    </div>

    <div id="root"></div>
  </div>

<script>
  const IT = {
    monthNames: ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'],
    dayNames: ['Domenica','Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato'],
  };

  function parseYMD(s){
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  function formatDateIT(dateStr){
    const d = parseYMD(dateStr);
    return `${IT.dayNames[d.getDay()]} ${d.getDate()} ${IT.monthNames[d.getMonth()]}`;
  }

  async function apiGetWeek(){
    const res = await fetch("/.netlify/functions/week", { cache: "no-store" });
    const j = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(j.error || "week API failed");
    return j;
  }

  function byName(a,b){
    return a.localeCompare(b, "it", { sensitivity: "base" });
  }

  function bucketizeForDate(dateStr, members, responses){
    const yes = [];
    const no = [];
    const maybe = [];
    const none = [];

    // map member_id -> status for that date
    const map = new Map();
    for(const r of responses){
      if(r.training_date === dateStr){
        map.set(r.member_id, r.status);
      }
    }

    for(const m of members){
      const s = map.get(m.id) || null;
      if(s === "yes") yes.push(m.name);
      else if(s === "no") no.push(m.name);
      else if(s === "maybe") maybe.push(m.name);
      else none.push(m.name);
    }

    yes.sort(byName); no.sort(byName); maybe.sort(byName); none.sort(byName);
    return { yes, no, maybe, none };
  }

  function renderNames(arr){
    if(!arr.length) return `<div class="empty">Nessuno</div>`;
    return `<div class="names">${arr.map(n => `<span class="nameChip">${escapeHtml(n)}</span>`).join("")}</div>`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadAndRender(){
    const root = document.getElementById("root");
    root.innerHTML = `<div class="card"><div class="muted">Caricamento‚Ä¶</div></div>`;

    try{
      const week = await apiGetWeek();
      document.getElementById("subtitle").textContent =
        `Settimana: ${week.weekId} ‚Ä¢ Giorni allenamento: ${week.trainingDates.length} ‚Ä¢ Membri: ${week.members.length}`;

      root.innerHTML = week.trainingDates.map(dateStr => {
        const b = bucketizeForDate(dateStr, week.members, week.responses);

        return `
          <div class="card">
            <div class="dayTitle">${formatDateIT(dateStr)}</div>

            <div class="grid">
              <div class="bucket">
                <div class="bucketTitle">
                  <span>‚úÖ Presente</span>
                  <span class="pill green">${b.yes.length}</span>
                </div>
                ${renderNames(b.yes)}
              </div>

              <div class="bucket">
                <div class="bucketTitle">
                  <span>‚ùå Assente</span>
                  <span class="pill red">${b.no.length}</span>
                </div>
                ${renderNames(b.no)}
              </div>

              <div class="bucket">
                <div class="bucketTitle">
                  <span>‚ùì Forse</span>
                  <span class="pill yellow">${b.maybe.length}</span>
                </div>
                ${renderNames(b.maybe)}
              </div>

              <div class="bucket">
                <div class="bucketTitle">
                  <span>üï≥Ô∏è Non ha risposto</span>
                  <span class="pill gray">${b.none.length}</span>
                </div>
                ${renderNames(b.none)}
              </div>
            </div>
          </div>
        `;
      }).join("");

    }catch(e){
      document.getElementById("subtitle").textContent = "Errore";
      root.innerHTML = `
        <div class="card">
          <div style="font-weight:900;margin-bottom:6px">Errore nel caricamento</div>
          <div class="muted">${escapeHtml(e?.message || e)}</div>
          <div class="sep"></div>
          <div class="muted">Controlla che <b>/.netlify/functions/week</b> risponda e che la DB sia ok.</div>
        </div>
      `;
    }
  }

  document.getElementById("reload").onclick = loadAndRender;
  loadAndRender();
</script>
</body>
</html>
