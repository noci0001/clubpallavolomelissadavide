<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disponibilità Allenamenti – Settimana</title>

  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#020617;
      color:#f9fafb;
    }
    .app{max-width:720px;margin:0 auto;padding:16px}
    .card{
      background:#0b1120;
      border:1px solid #1f2937;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
    }
    .title{font-size:22px;font-weight:800;color:#f97316}
    .date{font-size:16px;font-weight:700;margin-bottom:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid #4b5563;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .yes.sel{background:#22c55e;color:#000;border-color:#22c55e}
    .no.sel{background:#ef4444;color:#000;border-color:#ef4444}
    .maybe.sel{background:#eab308;color:#000;border-color:#eab308}
    .muted{color:#9ca3af;font-size:13px}
  </style>
</head>
<body>

<div class="app">
  <div class="title">Disponibilità allenamenti – settimana</div>
  <div class="muted" style="margin-bottom:16px">
    Seleziona la tua presenza per ogni allenamento.
  </div>

  <div id="list"></div>
</div>

<script>
/* ===== UI + date helpers (same vibe as your current file) ===== */
const IT = {
  monthNames: ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'],
  dayNames: ['Domenica','Lunedì','Martedì','Mercoledì','Giovedì','Venerdì','Sabato'],
};

function parseYMD(s){
  const [y,m,d] = s.split('-').map(Number);
  return new Date(y, m-1, d);
}
function formatDateIT(dateStr){
  const d = parseYMD(dateStr);
  return `${IT.dayNames[d.getDay()]} ${d.getDate()} ${IT.monthNames[d.getMonth()]}`;
}

/* ===== member code stored on device ===== */
const STORAGE_MEMBER_CODE = "volleyclub_member_code";

let state = {
  memberCode: localStorage.getItem(STORAGE_MEMBER_CODE) || "",
  week: null, // { weekId, trainingDates, members, responses }
};

/* ===== API calls (Netlify Functions) ===== */
async function apiGetWeek(){
  const res = await fetch("/.netlify/functions/week", { cache: "no-store" });
  if(!res.ok){
    let msg = "week API failed";
    try{ msg = (await res.json()).error || msg; }catch{}
    throw new Error(msg);
  }
  return res.json();
}

async function apiRespond(training_date, status){
  const res = await fetch("/.netlify/functions/respond", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      member_code: state.memberCode,
      training_date,
      status
    })
  });

  const j = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(j.error || "respond failed");
  return j;
}

/* ===== find current member + current vote ===== */
function findMyMember(members){
  const c = state.memberCode.trim();
  if(!c) return null;
  return members.find(m => m.member_code === c) || null;
}
function myStatusForDate(responses, memberId, dateStr){
  const r = responses.find(x => x.member_id === memberId && x.training_date === dateStr);
  return r ? r.status : null;
}

/* ===== render ===== */
function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  // Top card: member code input
  const top = document.createElement("div");
  top.className = "card";
  top.innerHTML = `
    <div style="font-weight:900;font-size:16px;margin-bottom:8px;color:#f97316">Identificati</div>
    <div class="muted" style="margin-bottom:10px">
      Inserisci il tuo <b>codice membro</b> (te lo dà l’admin). Rimane salvato sul telefono.
    </div>
    <input id="code"
      placeholder="Es: SAM-7F2K"
      value="${state.memberCode.replaceAll('"','&quot;')}"
      style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#020617;color:#f9fafb" />
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="saveCode" style="padding:10px 12px;border-radius:8px;border:0;background:#f97316;font-weight:800;cursor:pointer">SALVA CODICE</button>
      <button id="reload" style="padding:10px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:800;cursor:pointer">RICARICA</button>
      <button id="clearCode" style="padding:10px 12px;border-radius:8px;border:1px solid #4b5563;background:transparent;color:#9ca3af;font-weight:800;cursor:pointer">RESET</button>
    </div>
  `;
  list.appendChild(top);

  document.getElementById("saveCode").onclick = async () => {
    state.memberCode = document.getElementById("code").value.trim();
    localStorage.setItem(STORAGE_MEMBER_CODE, state.memberCode);
    await loadWeekAndRender();
  };
  document.getElementById("clearCode").onclick = () => {
    state.memberCode = "";
    localStorage.removeItem(STORAGE_MEMBER_CODE);
    render();
  };
  document.getElementById("reload").onclick = loadWeekAndRender;

  // If week not loaded yet
  if(!state.week){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `<div class="muted">Caricamento…</div>`;
    list.appendChild(c);
    return;
  }

  const me = findMyMember(state.week.members);
  if(!me){
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <div style="font-weight:800">Codice non valido o non inserito.</div>
      <div class="muted">Inserisci un codice membro corretto per votare.</div>
    `;
    list.appendChild(c);
    return;
  }

  // Header
  const header = document.createElement("div");
  header.className = "card";
  header.innerHTML = `
    <div style="font-weight:900;font-size:18px;margin-bottom:6px">Ciao ${me.name}</div>
    <div class="muted">Settimana: <b>${state.week.weekId}</b></div>
  `;
  list.appendChild(header);

  // Training days cards
  for(const dateStr of state.week.trainingDates){
    const current = myStatusForDate(state.week.responses, me.id, dateStr);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="date">${formatDateIT(dateStr)}</div>
      <div class="chips">
        <div class="chip yes ${current==='yes'?'sel':''}" data-date="${dateStr}" data-status="yes">✅ Presente</div>
        <div class="chip no ${current==='no'?'sel':''}" data-date="${dateStr}" data-status="no">❌ Assente</div>
        <div class="chip maybe ${current==='maybe'?'sel':''}" data-date="${dateStr}" data-status="maybe">❓ Forse</div>
      </div>
      <div class="muted" style="margin-top:8px;font-size:12px">Salvataggio immediato (database).</div>
    `;
    list.appendChild(card);
  }

  // Bind clicks
  list.querySelectorAll("[data-status]").forEach(el => {
    el.onclick = async () => {
      const dateStr = el.getAttribute("data-date");
      const status = el.getAttribute("data-status");
      try{
        await apiRespond(dateStr, status);
        await loadWeekAndRender(); // refresh to show selected state
      }catch(e){
        alert(e?.message || e);
      }
    };
  });
}

async function loadWeekAndRender(){
  try{
    state.week = await apiGetWeek();
  }catch(e){
    state.week = null;
    alert("Errore caricamento settimana: " + (e?.message || e));
  }
  render();
}

loadWeekAndRender();
</script>


</body>
</html>
